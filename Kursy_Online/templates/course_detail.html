{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szczegóły kursu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><img src="{% static 'logo.png' %}" alt="Logo" class="logo"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'home' %}">Strona Główna</a>
                        </li>
                        {% if user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">Profil</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="">Moje kursy</a></li>
                                    <li><a class="dropdown-item" href="{% url 'create_course' %}">Stwórz kurs</a></li>
                                    <li><a class="dropdown-item" href="">Mój profil</a></li>
                                    <li>                                
                                        <form method="post" action="{% url 'auth-logout' %}" class="d-inline" id="logout-form">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item">Wyloguj</button>
                                        </form>
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <span class="nav-link">Witaj, {{ user.username }}!</span>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'login' %}">Logowanie</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'register' %}">Rejestracja</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div id="root"></div>

    <script type="text/babel">
        const appData = {
            courseId: "{{ course_id }}",
            isAuthenticated: "{% if user.is_authenticated %}true{% else %}false{% endif %}" === "true",
            csrfToken: "{{ csrf_token }}"
        };

        const CourseDetail = ({ courseId, isAuthenticated, csrfToken }) => {
            const [course, setCourse] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [isInstructor, setIsInstructor] = React.useState(false);
            const [isModerator, setIsModerator] = React.useState(false);

            React.useEffect(() => {
                const fetchCourse = async () => {
                    try {
                        const response = await fetch(`/api/courses/${courseId}/`);
                        if (!response.ok) throw new Error('Failed to fetch course');
                        const data = await response.json();
                        setCourse(data);
                        
                        if (data.instructor?.username === "{{ user.username }}") {
                            setIsInstructor(true);
                        }
                        if (data.moderators?.some(mod => mod.username === "{{ user.username }}")) {
                            setIsModerator(true);
                        }
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchCourse();
            }, [courseId]);

            if (loading) return <div>Loading...</div>;
            if (error) return <div>Error: {error}</div>;
            if (!course) return <div>No course data available</div>;

            return (
                <div className="container my-5">
                    <div className="row mb-4">
                        <div className="col-md-8">
                            <h1 className="mb-3">{course.title || 'Untitled Course'}</h1>
                            <h6>Opis kursu</h6>
                            <p className="lead">{course.description || 'No description available'}</p>
                            
                            {course.average_rating !== undefined && (
                                <div className="mb-3">
                                    <span className="badge bg-primary me-2">
                                        Rating: {course.average_rating?.toFixed(1) || 'No ratings'}
                                        {course.total_reviews && ` (${course.total_reviews} reviews)`}
                                    </span>
                                </div>
                            )}

                            {course.technologies?.length > 0 && (
                                <div className="mb-3">
                                    {course.technologies.map(tech => (
                                        <span key={tech.id} className="badge bg-secondary me-1">
                                            {tech.name}
                                        </span>
                                    ))}
                                </div>
                            )}

                            <div className="mt-4">
                                <div className="d-flex justify-content-between align-items-center">
                                    <h4>Zawartość kursu</h4>
                                    {(isInstructor || isModerator) && (
                                        <a href={`/courses/${courseId}/add-chapter`} 
                                           className="btn btn-primary">
                                            Dodaj nowy dział
                                        </a>
                                    )}
                                </div>
                                {course.chapters?.length > 0 ? (
                                    <div className="chapters mt-3">
                                        {course.chapters.map(chapter => (
                                            <div key={chapter.id} className="card mb-2">
                                                <div className="card-body">
                                                    <h5>{chapter.title}</h5>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="mt-3">Ten kurs nie ma jeszcze żadnych działów</p>
                                )}
                            </div>
                        </div>

                        {course.cover_image && (
                            <div className="col-md-4">
                                <img 
                                    src={course.cover_image} 
                                    alt={course.title} 
                                    className="img-fluid rounded"
                                    onError={(e) => {
                                        e.target.onerror = null;
                                        e.target.src = '/static/default-course-image.jpg';
                                    }}
                                />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <CourseDetail 
                courseId={appData.courseId} 
                isAuthenticated={appData.isAuthenticated} 
                csrfToken={appData.csrfToken} 
            />
        );
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>